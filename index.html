<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFT Synergy Calculator Optimized</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let championsData = [];
        let synergiesData = [];

        // CSV 로딩 (원본 코드와 동일)
        async function loadChampionsData() {
            return new Promise((resolve, reject) => {
                Papa.parse('champions.csv', {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        championsData = results.data.map(row => ({
                            name: row.Champion,
                            synergies: row.Synergies.split(',').map(s => s.trim()),
                            cost: parseInt(row.cost, 10)
                        }));
                        resolve();
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });
        }

        // 시너지 CSV 로딩 (원본 코드와 동일)
        async function loadSynergiesData() {
            return new Promise((resolve, reject) => {
                Papa.parse('synergies.csv', {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        synergiesData = results.data.map(row => ({
                            synergy: row.Synergy.trim(),
                            // "2,4,6" 형태 -> [2,4,6] 숫자 배열
                            requirements: row.RequirementStages.split(',').map(num => parseInt(num.trim(), 10))
                        }));
                        resolve();
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });
        }

        async function displayFilePreviews() {
            const filePreviewDiv = document.getElementById('file-preview');
            try {
                await Promise.all([loadChampionsData(), loadSynergiesData()]);

                // 콘솔로 데이터 확인
                console.log('Champions data loaded:', championsData);
                console.log('Synergies data loaded:', synergiesData);

                // 일부 미리보기 출력
                const championPreview = championsData.slice(0, 2)
                    .map(champ => `${champ.name} (${champ.synergies.join(', ')}): ${champ.cost}`).join('<br>');
                const synergyPreview = synergiesData.slice(0, 2)
                    .map(syn => `${syn.synergy}: ${syn.requirements.join(', ')}`).join('<br>');

                filePreviewDiv.innerHTML = `
                    <h3>Champion File Preview:</h3>${championPreview}
                    <h3>Synergy File Preview:</h3>${synergyPreview}
                `;
            } catch (err) {
                console.error('Failed to load data:', err);
                filePreviewDiv.innerHTML = '<p style="color: red;">Error: Failed to load champion or synergy data.</p>';
            }
        }

        // ----------------------------------------------------------------------------
        // 여기서부터가 "calculateCombinations" 최적화 버전
        // ----------------------------------------------------------------------------
        function calculateCombinations() {
            const inputSynergies = document.getElementById('synergies').value
                .split(',')
                .map(s => s.trim())
                .filter(s => s);
            const maxCost = document.getElementById('max-cost').value
                ? parseInt(document.getElementById('max-cost').value, 10)
                : null;

            // 원하는(필수) 시너지 목록 (공백 입력 시 synergiesData 전체로 대체)
            const mainSynergies = inputSynergies.length > 0
                ? inputSynergies
                : synergiesData.map(s => s.synergy);

            // 비용 제한에 맞는 챔피언만 추출
            const validChampions = championsData.filter(champ => {
                return maxCost === null || champ.cost <= maxCost;
            });

            // 만약 제한조건에 맞는 챔피언이 없다면 바로 종료
            if (validChampions.length === 0) {
                document.getElementById('results').innerHTML = '<li>No valid champions under the specified cost.</li>';
                return;
            }

            // 시너지 이름 -> 요구사항 배열 (ex: { "정복자": [2,4,6], ... })
            const synergyRequirementsMap = {};
            synergiesData.forEach(s => {
                synergyRequirementsMap[s.synergy] = s.requirements;
            });

            // 시너지 활성화 여부 판단 함수
            // synergyRequirementsMap[시너지]가 예: [2,4,6] 이면
            // count(챔피언 수)가 2 이상이면 활성화, 4 이상이면 더 높은 단계 활성화... 
            // 여기서는 "하나라도 만족하면 활성"으로 판단
            function isSynergyActive(synergy, count) {
                const reqs = synergyRequirementsMap[synergy];
                if (!reqs) return false; // 혹시 CSV에 없는 시너지 이름일 때
                return reqs.some(req => count >= req);
            }

            // 현재 synergyCounts 객체를 보고 몇 개의 시너지가 활성화중인지 계산
            function getActiveSynergyCount(synergyCounts) {
                let activeCount = 0;
                for (const synergy in synergyCounts) {
                    if (isSynergyActive(synergy, synergyCounts[synergy])) {
                        activeCount++;
                    }
                }
                return activeCount;
            }

            // "메인 시너지"가 모두 활성화되었는지 확인
            function allMainSynergiesActive(synergyCounts) {
                // mainSynergies 각각이 synergyCounts 에 존재하고, isSynergyActive가 true인지
                for (const synergy of mainSynergies) {
                    const count = synergyCounts[synergy] || 0;
                    if (!isSynergyActive(synergy, count)) {
                        return false;
                    }
                }
                return true;
            }

            // 결과 보관용 (중복 제거 위해 Set 사용 가능)
            const validCombinations = new Set();

            // 백트래킹으로 조합 찾기
            // synergyCounts: { 시너지이름: 챔피언 수 }  ex) { 정복자: 2, 검은장미단: 1, ... }
            // activeCount: 현재 synergyCounts 기준 활성화된 시너지의 개수
            // combinationIndices: 현재까지 포함한 챔피언의 인덱스 목록
            function backtrack(startIndex, synergyCounts, activeCount, combinationIndices) {
                // 조건 충족 시(8개 이상 + 메인 시너지 활성화) 결과에 기록
                if (activeCount >= 8 && allMainSynergiesActive(synergyCounts)) {
                    // 챔피언 이름 배열 추출
                    const comboNames = combinationIndices.map(i => validChampions[i].name).sort();
                    validCombinations.add(comboNames.join(', '));
                    // 백트래킹이므로 여기서도 계속 탐색(더 긴 조합도 존재할 수 있음)
                }

                // 더 이상 선택할 챔피언이 없거나, 조합 크기가 9마리 이상이면(원하는 최대 수)
                if (startIndex >= validChampions.length || combinationIndices.length >= 9) {
                    return;
                }

                // 다음 챔피언을 "선택 안 함"
                backtrack(startIndex + 1, synergyCounts, activeCount, combinationIndices);

                // 다음 챔피언을 "선택"하는 경우
                const champion = validChampions[startIndex];
                // synergyCounts를 업데이트(챔피언의 모든 시너지에 +1)
                champion.synergies.forEach(syn => {
                    synergyCounts[syn] = (synergyCounts[syn] || 0) + 1;
                });
                const newActiveCount = getActiveSynergyCount(synergyCounts);

                combinationIndices.push(startIndex);
                backtrack(startIndex + 1, synergyCounts, newActiveCount, combinationIndices);

                // 백트래킹 복구
                combinationIndices.pop();
                champion.synergies.forEach(syn => {
                    synergyCounts[syn]--;
                    if (synergyCounts[syn] <= 0) {
                        delete synergyCounts[syn];
                    }
                });
            }

            // 백트래킹 시작
            backtrack(
                0,                  // startIndex
                {},                 // synergyCounts (처음엔 비어있음)
                0,                  // activeCount
                []                  // combinationIndices
            );

            // 결과 출력
            const resultsList = document.getElementById('results');
            resultsList.innerHTML = '';
            if (validCombinations.size === 0) {
                resultsList.innerHTML = '<li>No valid combinations found.</li>';
            } else {
                validCombinations.forEach(combo => {
                    const li = document.createElement('li');
                    li.textContent = combo;
                    resultsList.appendChild(li);
                });
            }
        }

        // 페이지 로드시 CSV 로딩
        window.onload = displayFilePreviews;
    </script>
</head>
<body>
    <h1>Champion Synergy Calculator (Optimized)</h1>

    <div id="file-preview"></div>

    <div id="app">
        <label for="synergies">Select Desired Synergies (comma-separated):</label>
        <input type="text" id="synergies" placeholder="예: 정복자, 검은장미단">

        <label for="max-cost">Set Maximum Cost:</label>
        <input type="number" id="max-cost" placeholder="e.g., 2">

        <button onclick="calculateCombinations()">Calculate Combinations</button>

        <h2>Results</h2>
        <ul id="results"></ul>
    </div>
</body>
</html>
